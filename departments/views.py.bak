"""
departments/views.py

Purpose:
  - Provide both HTML-rendering views (for the frontend UI) and DRF API views
    (for programmatic access). This file is intentionally non-breaking:
      * API views are preserved exactly (same behavior and signatures).
      * HTML views are added under the `ui/` routes so they do not interfere
        with existing API routes.

Structure:
  - Section A: Frontend HTML views (Django generic views)
  - Section B: API views (Django REST Framework APIView) â€” preserved
"""

# ---------------------------
# Section A: Frontend HTML views
# ---------------------------
from django.views.generic import ListView, DetailView

# Import the Department model used by the templates.
# If your model is named differently, update this import accordingly.
from .models import Department

# We intentionally do not add authentication mixins here so the pages are
# viewable during development. If you want to restrict access, add
# LoginRequiredMixin or similar.
class DepartmentListPageView(ListView):
    """
    HTML page: Departments list (grid of cards).

    Template:
      - Expected file name: departments_list.html
      - Location (per your preference): MedApp/departments/departments_frontend/templates/departments_list.html

    Context provided to template:
      - departments: paginated queryset of Department objects
      - crumbs: breadcrumb list for includes/breadcrumbs.html
      - filters: placeholder filter metadata (replace with real filters if available)
      - show_search: boolean to toggle search UI
    """
    model = Department
    context_object_name = "departments"
    paginate_by = 9
    template_name = "departments_list.html"  # matches your file name in departments_frontend/templates

    def get_queryset(self):
        """
        Optionally scope by hospital_id query param if provided.
        This mirrors the API behavior where departments are often scoped to a hospital.
        If hospital_id is not provided, return all departments so the UI shows everything.
        """
        hospital_id = self.request.GET.get("hospital_id")
        if hospital_id:
            # Prefer service layer if available; fallback to model-level filtering.
            try:
                # If you have a service function that returns department objects:
                from .services import get_departments_for_hospital
                return get_departments_for_hospital(hospital_id)
            except Exception:
                # Fallback: try a model-level filter if a relationship exists
                try:
                    return Department.objects.filter(hospital__id=hospital_id)
                except Exception:
                    # If relationships are not defined, return empty queryset
                    return Department.objects.none()
        return Department.objects.all()

    def get_context_data(self, **kwargs):
        """
        Provide additional context used by the frontend templates and includes.
        Keep these keys stable so includes like filters.html and breadcrumbs.html
        can rely on them.
        """
        context = super().get_context_data(**kwargs)
        context["crumbs"] = [
            {"label": "Home", "url": "/"},
            {"label": "Departments", "url": None},
        ]
        # Placeholder filters structure; replace with real filter options if available.
        context["filters"] = [
            {"label": "All", "value": "all", "active": True},
        ]
        context["show_search"] = True
        return context


class DepartmentDetailPageView(DetailView):
    """
    HTML page: Department detail.

    Template:
      - Expected file name: departments_detail.html
      - Location (per your preference): MedApp/departments/departments_frontend/templates/departments_detail.html

    Context provided to template:
      - department: the Department instance (available as `department` and `object`)
      - doctors: list/queryset of doctors related to this department (if available)
      - hospitals: list/queryset of hospitals related to this department (if available)
      - crumbs: breadcrumb list
    """
    model = Department
    context_object_name = "department"
    template_name = "departments_detail.html"  # matches your file name in departments_frontend/templates

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        dept = self.object

        # Safely attempt to populate related doctors and hospitals.
        # If your models use different related names, update these attribute names.
        try:
            doctors_rel = getattr(dept, "doctors", None)
            doctors_qs = doctors_rel.all() if doctors_rel is not None and hasattr(doctors_rel, "all") else []
        except Exception:
            doctors_qs = []

        try:
            hospitals_rel = getattr(dept, "hospitals", None)
            hospitals_qs = hospitals_rel.all() if hospitals_rel is not None and hasattr(hospitals_rel, "all") else []
        except Exception:
            hospitals_qs = []

        context["doctors"] = doctors_qs
        context["hospitals"] = hospitals_qs
        context["crumbs"] = [
            {"label": "Home", "url": "/"},
            {"label": "Departments", "url": "/departments/"},
            {"label": dept.name, "url": None},
        ]
        return context


# ---------------------------
# Section B: API views (Django REST Framework)
# ---------------------------
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status, permissions

# Service-layer functions and serializer imports (preserve existing behavior)
from .services import add_department, delete_department, edit_department, get_departments_for_hospital
from .serializers import DepartmentSerializer


class DepartmentListCreateView(APIView):
    """
    API endpoint for listing and creating departments (unchanged behavior).

    - GET  /departments/?hospital_id=<id>  -> returns JSON list of departments (hospital_id required)
    - POST /departments/                    -> creates a department (JSON body)
    Permissions:
      - IsAuthenticated (preserved)
    """
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        # Preserve original behavior: require hospital_id query param
        hospital_id = request.query_params.get("hospital_id")
        if not hospital_id:
            return Response({"error": "hospital_id required"}, status=status.HTTP_400_BAD_REQUEST)

        depts = get_departments_for_hospital(hospital_id)
        return Response(DepartmentSerializer(depts, many=True).data)

    def post(self, request):
        data = request.data
        dept = add_department(
            hospital_id=data["hospital_id"],
            name=data["name"],
            description=data.get("description", ""),
            head_doctor_id=data.get("head_doctor_id")
        )
        return Response(DepartmentSerializer(dept).data, status=status.HTTP_201_CREATED)


class DepartmentDetailView(APIView):
    """
    API endpoint for updating and deleting a department (unchanged behavior).

    - PUT    /departments/<dept_id>/  -> updates department
    - DELETE /departments/<dept_id>/  -> deletes department
    Permissions:
      - IsAuthenticated (preserved)
    """
    permission_classes = [permissions.IsAuthenticated]

    def put(self, request, dept_id):
        dept = edit_department(dept_id, **request.data)
        return Response(DepartmentSerializer(dept).data)

    def delete(self, request, dept_id):
        hospital_id = request.data.get("hospital_id")
        name = request.data.get("name")
        delete_department(hospital_id, name)
        return Response(status=status.HTTP_204_NO_CONTENT)
