{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <!-- Charset and viewport for responsive, accessible layout -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- Page title: each view can override this block -->
    <title>{% block title %}MedApp - Modern Healthcare Platform{% endblock %}</title>

    <!-- ENHANCED: New design system (MUST BE FIRST) -->
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">

    <!-- Design tokens: central source of truth for colors, spacing, typography -->
    <link rel="stylesheet" href="{% static 'css/tokens.css' %}">

    <!-- Shared component styles (cards, badges, stats, skeletons, images, interactions) -->
    <link rel="stylesheet" href="{% static 'css/components/card.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/badge.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/stats_block.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/skeleton.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/image.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/interactions.css' %}">

    <!-- Optional: Bootstrap CSS (CDN) for grid/components -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Page/component-specific CSS -->
    {% block styles %}{% endblock %}
    {% block extra_css %}{% endblock %}
  </head>
  <body class="medapp-root">
    <!-- Accessibility: skip to main content for keyboard users -->
    <a class="visually-hidden-focusable" href="#main-content">Skip to main content</a>

    <!-- ENHANCED: Modern Navigation Bar -->
    <nav class="main-nav">
      <div class="nav-container">
        <a href="/" class="nav-logo">
          <div class="nav-logo-icon">ğŸ¥</div>
          <span class="nav-logo-text">MedApp</span>
        </a>
        
        {% if user.is_authenticated %}
          <ul class="nav-links" id="navLinks">
            <li class="nav-link">
              <a href="{% url 'patients:dashboard' %}">
                <span>ğŸ“Š</span>
                <span>Dashboard</span>
              </a>
            </li>
            <li class="nav-link">
              <a href="{% url 'appointments:appointment-list' %}">
                <span>ğŸ“…</span>
                <span>Appointments</span>
              </a>
            </li>
            <li class="nav-link">
              <a href="{% url 'doctors:doctor-list' %}">
                <span>ğŸ‘¨â€âš•ï¸</span>
                <span>Doctors</span>
              </a>
            </li>
            <li class="nav-link">
              <a href="{% url 'prescriptions:list' %}">
                <span>ğŸ’Š</span>
                <span>Prescriptions</span>
              </a>
            </li>
          </ul>
          
          <div class="nav-user">
            <button class="nav-notifications" aria-label="Notifications">
              ğŸ””
              {% if notification_count %}
              <span class="notification-badge">{{ notification_count }}</span>
              {% endif %}
            </button>
            
            <div class="nav-user-menu">
              <button class="nav-user-button" aria-expanded="false" aria-haspopup="true">
                <div class="nav-user-avatar">
                  {% if user.first_name and user.last_name %}
                    {{ user.first_name|first }}{{ user.last_name|first }}
                  {% else %}
                    {{ user.username|first|upper }}
                  {% endif %}
                </div>
                <span>{{ user.first_name|default:user.username }}</span>
                <span class="nav-dropdown-icon">â–¼</span>
              </button>
              
              <div class="nav-dropdown">
                <div class="nav-dropdown-header">
                  <div class="nav-dropdown-name">{{ user.get_full_name|default:user.username }}</div>
                  <div class="nav-dropdown-email">{{ user.email }}</div>
                </div>
                <div class="nav-dropdown-items">
                  <a href="{% url 'accounts:profile' %}" class="nav-dropdown-item">
                    <span class="nav-dropdown-item-icon">ğŸ‘¤</span>
                    <span>My Profile</span>
                  </a>
                  <a href="{% url 'patients:history' %}" class="nav-dropdown-item">
                    <span class="nav-dropdown-item-icon">ğŸ“‹</span>
                    <span>Medical History</span>
                  </a>
                  <a href="{% url 'reports:dashboard' %}" class="nav-dropdown-item">
                    <span class="nav-dropdown-item-icon">ğŸ“</span>
                    <span>My Reports</span>
                  </a>
                  <div class="nav-dropdown-divider"></div>
                  <a href="{% url 'accounts:logout' %}" class="nav-dropdown-item logout">
                    <span class="nav-dropdown-item-icon">ğŸšª</span>
                    <span>Logout</span>
                  </a>
                </div>
              </div>
            </div>
          </div>
          
          <button class="nav-mobile-toggle" aria-label="Toggle menu" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
          </button>
        {% else %}
          <!-- LOGIN/SIGNUP SECTION HIDDEN FOR NOW -->
          <ul class="nav-links" id="navLinks">
            <li class="nav-link">
              <a href="{% url 'doctors:doctor-list' %}">
                <span>ğŸ‘¨â€âš•ï¸</span>
                <span>Find Doctors</span>
              </a>
            </li>
          </ul>
        {% endif %}
      </div>
    </nav>

    <!-- Main layout (Bootstrap grid for responsive structure) -->
    <main id="main-content" class="medapp-main">
      <!-- ENHANCED: Full-width content (no container constraint for modern pages) -->
      {% block content %}{% endblock %}

      <!-- LEGACY: Bootstrap grid layout (for pages that need it) -->
      {% block legacy_content %}
        <div class="container-fluid py-3">
          <div class="row gx-4">
            <!-- Optional sidebar -->
            <aside class="col-12 col-lg-3 medapp-sidebar">
              {% block sidebar %}{% endblock %}
            </aside>

            <!-- Primary page content -->
            <section class="col-12 col-lg-9 medapp-content">
              {% block legacy_section %}{% endblock %}
            </section>
          </div>
        </div>
      {% endblock %}
    </main>

    <!-- Inline JSON data block: views can inject small payloads -->
    <script id="medapp-inline-data" type="application/json">
      {% block inline-data %}{}{% endblock %}
    </script>

    <!-- Bootstrap JS bundle (Popper included) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ENHANCED: Navigation JavaScript -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Navigation dropdown toggle
        const userMenu = document.querySelector('.nav-user-menu');
        const userButton = document.querySelector('.nav-user-button');
        
        if (userButton && userMenu) {
          userButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = userMenu.classList.toggle('open');
            userButton.setAttribute('aria-expanded', isOpen);
          });
          
          // Close dropdown on outside click
          document.addEventListener('click', (e) => {
            if (!userMenu.contains(e.target)) {
              userMenu.classList.remove('open');
              userButton.setAttribute('aria-expanded', 'false');
            }
          });
          
          // Close on Escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && userMenu.classList.contains('open')) {
              userMenu.classList.remove('open');
              userButton.setAttribute('aria-expanded', 'false');
              userButton.focus();
            }
          });
        }
        
        // Mobile menu toggle
        const mobileToggle = document.querySelector('.nav-mobile-toggle');
        const navLinks = document.getElementById('navLinks');
        
        if (mobileToggle && navLinks) {
          mobileToggle.addEventListener('click', () => {
            const isOpen = mobileToggle.classList.toggle('open');
            navLinks.classList.toggle('open');
            mobileToggle.setAttribute('aria-expanded', isOpen);
          });
          
          // Close mobile menu when clicking a link
          navLinks.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
              mobileToggle.classList.remove('open');
              navLinks.classList.remove('open');
              mobileToggle.setAttribute('aria-expanded', 'false');
            });
          });
        }
        
        // Scroll effect for navbar
        const nav = document.querySelector('.main-nav');
                window.addEventListener('scroll', () => {
          const currentScroll = window.pageYOffset;

          if (currentScroll > 50) {
            nav.classList.add('scrolled');
          } else {
            nav.classList.remove('scrolled');
          }
        });

        // Highlight active navigation link
        const currentPath = window.location.pathname;
        document.querySelectorAll('.nav-link a').forEach(link => {
          const href = link.getAttribute('href');
          if (href === currentPath || currentPath.startsWith(href + '/')) {
            link.parentElement.classList.add('active');
          }
        });
      });
    </script>

    <!-- Shared component scripts (interactions, card reveal) -->
    <script src="{% static 'js/components/interactions.js' %}" defer></script>
    <script src="{% static 'js/components/card.js' %}" defer></script>

    <!-- Global JS entry (namespace, component registry, auto-mount) -->
    <script src="{% static 'js/base.js' %}"></script>

    <!-- Page/component-specific scripts -->
    {% block scripts %}{% endblock %}

    <!-- Footer (overridable block) -->
    <footer class="medapp-footer mt-4">
      {% block footer %}
        {% include 'includes/footer.html' %}
      {% endblock %}
    </footer>
  </body>
</html>
